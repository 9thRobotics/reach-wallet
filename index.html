<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Buy Reach 9D-RC Token</title>
  <style>
    body {font-family: Arial, sans-serif;background:#0a0a0a;color:#fff;text-align:center;padding:50px;}
    input,button{padding:10px;margin:10px;font-size:16px;}
    button{cursor:pointer}
    .connected{color:#4caf50}
    code{background:#222;padding:5px 10px;border-radius:6px;display:inline-block;}
  </style>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
</head>
<body>
  <h1>Buy Reach 9D-RC Token</h1>
  <p>Fixed Price: <strong>$27.00</strong> per token (≈ 0.009 ETH)</p>

  <button onclick="connectWallet()">🔗 Connect Wallet</button>
  <div id="wallet-address"></div>

  <input type="number" id="reachAmount" placeholder="Number of Reach tokens" step="1" min="1" />
  <p id="ethEstimate">ETH Needed: 0</p>
  <button onclick="buyTokens()">Buy Reach Token</button>

  <p>Official Reach Token Contract:</p>
  <p>
    <code>0x41A61CdCf40a074546423Bae987B81733F3FBAc5</code><br/>
    <a href="https://etherscan.io/token/0x41A61CdCf40a074546423Bae987B81733F3FBAc5" target="_blank" style="color:#4caf50;">View on Etherscan</a>
  </p>
  <button onclick="addToken()">➕ Add to MetaMask</button>

  <script>
    /* ─────────────────────────────────────────────
       Correct-checksum addresses with ethers.js
    ───────────────────────────────────────────── */
    const sellerAddress  = ethers.utils.getAddress("0x0557aFA4318989702376D50B45547F953b7F9B21".toLowerCase());
    const tokenAddress   = ethers.utils.getAddress("0x41A61CdCf40a074546423Bae987B81733F3FBAc5".toLowerCase());

    const tokenSymbol    = "9D-RC";
    const tokenDecimals  = 18;
    const pricePerReach  = 0.009;            // ETH per token

    /* ABIs */
    const sellerABI = [
      { "inputs":[{"internalType":"uint256","name":"minTokens","type":"uint256"}],
        "name":"buyTokens","outputs":[],"stateMutability":"payable","type":"function" }
    ];

    /* Web3Modal */
    const providerOptions = {
      walletconnect:{
        package:window.WalletConnectProvider.default,
        options:{ infuraId:"63f289c3783f403aa722e9bda1b680aa" }
      }
    };
    const web3Modal = new window.Web3Modal.default({
      cacheProvider:false,
      providerOptions,
      theme:"dark",
      mobileLinks:["metamask","trust","coinbase","rainbow"]
    });

    /* Globals */
    let provider, signer, sellerContract;

    /* Connect Wallet */
    async function connectWallet(){
      try{
        const instance = await web3Modal.connect();
        provider      = new ethers.providers.Web3Provider(instance);
        signer        = provider.getSigner();
        const addr    = await signer.getAddress();
        document.getElementById("wallet-address").innerHTML =
          `Connected: <span class='connected'>${addr}</span>`;
        sellerContract = new ethers.Contract(sellerAddress, sellerABI, signer);
      }catch(err){
        console.error("Wallet connect error:",err);
        alert("Wallet connection failed.");
      }
    }

    /* Update ETH estimate live */
    document.getElementById("reachAmount").addEventListener("input",()=>{
      const t = parseFloat(document.getElementById("reachAmount").value||"0");
      document.getElementById("ethEstimate").innerText = "ETH Needed: "+
        (t*pricePerReach).toFixed(6);
    });

    /* Buy Tokens */
    async function buyTokens(){
      try{
        const num = parseFloat(document.getElementById("reachAmount").value);
        if(!signer||!num||num<=0){ alert("Enter amount & connect wallet."); return; }

        // 1% buffer for micro-fee rounding
        const ethNeeded = num * pricePerReach * 1.01;
        const ethValue  = ethers.utils.parseEther(ethNeeded.toFixed(6));

        console.log(`Buying ${num} token(s) → sending ${ethNeeded.toFixed(6)} ETH`);
        const tx = await sellerContract.buyTokens(num,{
          value: ethValue,
          gasLimit: 300000
        });
        console.log("Tx hash:",tx.hash);
        await tx.wait();
        alert("✅ Purchase complete!");
      }catch(err){
        console.error("❌ Tx failed:",err);
        alert("Transaction failed: "+(err.data?.message||err.message));
      }
    }

    /* Add token to MetaMask */
    async function addToken(){
      if(!window.ethereum){ alert("MetaMask required."); return; }
      try{
        await window.ethereum.request({
          method:"wallet_watchAsset",
          params:{
            type:"ERC20",
            options:{ address:tokenAddress,symbol:tokenSymbol,decimals:tokenDecimals }
          }
        });
      }catch(err){ console.error("Add token error:",err); }
    }
  </script>
</body>
</html>
