<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Buy Reach Token (9D‑RC)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { background:#0a0a0a; color:#fff; font-family:sans-serif; text-align:center; padding:40px }
    input, button { font-size:16px; padding:12px 20px; margin:10px; border-radius:8px }
    button { cursor:pointer; background:#4caf50; border:none; color:#fff }
    button:hover { background:#45a049 }
    .status { margin-top:10px; font-size:14px }
    .error { color:#f44336 }
  </style>
</head>
<body>
  <h1>Reach 9D‑RC Token Sale</h1>

  <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
  <div id="walletStatus" class="status">Wallet not connected</div>

  <h2>Buy Reach Tokens</h2>
  <input type="number" id="tokenAmount" placeholder="Whole Tokens Only" min="1" step="1" />
  <div id="estimate" class="status">Enter token amount</div>
  <button onclick="buyTokens()">Buy Now</button>
  <div id="txStatus" class="status"></div>

  <button onclick="addTokenToWallet()">➕ Add 9D‑RC to Wallet</button>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
    const SELLER_ADDRESS = "0x0557afA4318989702376D50B45547F953b7F9B21";
    const TOKEN_ADDRESS = "0x41a61cdcf40a074546423bae987b81733f3fbac5";
    const CHAINLINK_FEED = "0x5f4ec3df9cbd43714fe2740f5e3616155c5b8419"; // ETH/USD
    const USD_PER_TOKEN = 27;

    let provider, signer, userAddress;
    let isConnected = false;
    let isProcessing = false;

    async function connectWallet() {
      try {
        if (isConnected) {
          provider = null;
          signer = null;
          userAddress = null;
          isConnected = false;
          document.getElementById("walletStatus").textContent = "Wallet disconnected";
          document.getElementById("connectBtn").textContent = "Connect Wallet";
          return;
        }

        if (!window.ethereum) return alert("MetaMask or wallet required.");
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        isConnected = true;

        document.getElementById("walletStatus").textContent = `Connected: ${userAddress}`;
        document.getElementById("connectBtn").textContent = "Disconnect Wallet";
      } catch (err) {
        console.error("Wallet connect error:", err);
      }
    }

    async function getEthPriceUsd() {
      const feed = new ethers.Contract(
        CHAINLINK_FEED,
        [{
          "inputs": [], "name": "latestRoundData", "outputs": [
            { "name": "roundId", "type": "uint80" },
            { "name": "answer", "type": "int256" },
            { "name": "startedAt", "type": "uint256" },
            { "name": "updatedAt", "type": "uint256" },
            { "name": "answeredInRound", "type": "uint80" }
          ],
          "stateMutability": "view",
          "type": "function"
        }],
        provider
      );
      const data = await feed.latestRoundData();
      return Number(data.answer) / 1e8;
    }

    async function buyTokens() {
      if (!signer || !isConnected) return alert("Connect your wallet first.");
      if (isProcessing) return alert("Transaction already in progress...");
      isProcessing = true;

      const tokenCount = parseInt(document.getElementById("tokenAmount").value);
      if (!tokenCount || tokenCount <= 0 || !Number.isInteger(tokenCount)) {
        isProcessing = false;
        return alert("Enter a valid whole token amount.");
      }

      try {
        const ethPrice = await getEthPriceUsd();
        const totalUsd = tokenCount * USD_PER_TOKEN;
        const ethRequired = totalUsd / ethPrice;
        const ethValue = ethers.utils.parseEther(ethRequired.toFixed(6));
        const minTokens = ethers.utils.parseUnits(tokenCount.toString(), 18);

        const contract = new ethers.Contract(
          SELLER_ADDRESS,
          [{
            "inputs": [{ "internalType": "uint256", "name": "minTokens", "type": "uint256" }],
            "name": "buyTokens",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
          }],
          signer
        );

        document.getElementById("txStatus").textContent = "⏳ Confirming...";
        const tx = await contract.buyTokens(minTokens, {
          value: ethValue,
          gasLimit: 250000
        });
        await tx.wait();
        document.getElementById("txStatus").textContent = "✅ Token purchase successful!";
      } catch (err) {
        console.error("Buy error:", err);
        document.getElementById("txStatus").textContent = `❌ Failed: ${err.reason || err.message}`;
      }

      isProcessing = false;
    }

    async function addTokenToWallet() {
      try {
        await window.ethereum.request({
          method: 'wallet_watchAsset',
          params: {
            type: 'ERC20',
            options: {
              address: TOKEN_ADDRESS,
              symbol: '9D‑RC',
              decimals: 18,
              image: 'https://reachtoken.io/logo.png'
            }
          }
        });
      } catch (err) {
        console.error("Add token error:", err);
      }
    }

    // Estimate live ETH
    document.getElementById("tokenAmount").addEventListener("input", async () => {
      const tokens = parseInt(document.getElementById("tokenAmount").value);
      if (!tokens || tokens <= 0 || !Number.isInteger(tokens)) {
        document.getElementById("estimate").textContent = "Enter whole number of tokens";
        return;
      }

      try {
        const ethPrice = await getEthPriceUsd();
        const totalUsd = tokens * USD_PER_TOKEN;
        const ethNeeded = totalUsd / ethPrice;
        document.getElementById("estimate").textContent = `≈ ${ethNeeded.toFixed(6)} ETH ($${totalUsd.toFixed(2)})`;
      } catch (e) {
        document.getElementById("estimate").textContent = "Unable to fetch ETH price";
      }
    });
  </script>
</body>
</html>
