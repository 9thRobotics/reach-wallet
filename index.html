<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Buy Reach 9D-RC Token</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0a0a0a;color:#fff;text-align:center;padding:40px}
    input,button{padding:10px;margin:10px;font-size:16px;width:90%;max-width:320px}
    button{cursor:pointer}
    #buyBtn[disabled]{opacity:.6;cursor:not-allowed}
    .connected{color:#4caf50}
    code{background:#222;padding:5px 10px;border-radius:6px;display:inline-block}
  </style>

  <!-- Dependencies (load FIRST) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
</head>

<body>
  <h1>Buy Reach 9D-RC Token</h1>
  <p>Fixed price: <strong>$27</strong> (â‰ˆ 0.009 ETH) per token</p>

  <button id="connectBtn" onclick="connectWallet()">ðŸ”— Connect Wallet</button>
  <div id="wallet-address"></div>

  <input id="reachAmount" type="number" placeholder="Number of tokens" min="1" step="1" />
  <p id="ethEstimate">ETH Needed: 0</p>
  <button id="buyBtn" onclick="buyTokens()" disabled>Buy Reach Token</button>

  <p>Token contract:</p>
  <code>0x41A61CdCf40a074546423Bae987B81733F3FBAc5</code><br/>
  <a href="https://etherscan.io/token/0x41A61CdCf40a074546423Bae987B81733F3FBAc5" target="_blank" style="color:#4caf50">View on Etherscan</a><br/><br/>
  <button onclick="addToken()">âž• Add to MetaMask</button>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€  CUSTOM SCRIPT  (placed LAST, after all libs + HTML) â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script>
    /* Constants */
    const SELLER_ADDRESS = "0x0557AFA4318989702376D50B45547F953b7F9B21"; // checksummed âœ…
    const TOKEN_ADDRESS  = "0x41A61CdCf40a074546423Bae987B81733F3FBAc5";
    const TOKEN_SYMBOL   = "9D-RC";
    const TOKEN_DECIMALS = 18;
    const PRICE_ETH      = 0.009;   // per token

    /* ABIs */
    const sellerABI = [
      {
        inputs: [{internalType:"uint256",name:"minTokens",type:"uint256"}],
        name:   "buyTokens",
        outputs:[],
        stateMutability:"payable",
        type:"function"
      }
    ];

    /* Web3Modal setup */
    const providerOptions = {
      walletconnect:{
        package: window.WalletConnectProvider.default,
        options:{ infuraId:"63f289c3783f403aa722e9bda1b680aa" }
      }
    };
    const web3Modal = new window.Web3Modal.default({
      cacheProvider:false,
      providerOptions,
      theme:"dark",
      mobileLinks:["metamask","trust","coinbase","rainbow"]
    });

    /* Globals */
    let provider, signer, sellerContract;

    /* Connect wallet */
    async function connectWallet(){
      try{
        const instance = await web3Modal.connect();
        provider = new ethers.providers.Web3Provider(instance);
        signer   = provider.getSigner();
        const addr = await signer.getAddress();
        document.getElementById("wallet-address").innerHTML =
          `Connected: <span class="connected">${addr}</span>`;

        sellerContract = new ethers.Contract(
          SELLER_ADDRESS, sellerABI, signer
        );

        document.getElementById("buyBtn").disabled = false;
        document.getElementById("connectBtn").innerText = "âœ… Connected";
      }catch(e){
        console.error("Connect error:",e);
        alert("Wallet connection failed.");
      }
    }

    /* Live ETH estimate */
    document.getElementById("reachAmount").addEventListener("input",()=>{
      const amt = parseFloat(document.getElementById("reachAmount").value)||0;
      document.getElementById("ethEstimate").innerText =
        "ETH Needed: "+(amt*PRICE_ETH).toFixed(6);
    });

    /* Buy function */
    async function buyTokens(){
      try{
        if(!sellerContract){ await connectWallet(); }
        if(!sellerContract){ return; }

        const amt = parseFloat(document.getElementById("reachAmount").value);
        if(isNaN(amt)||amt<=0){ alert("Enter how many tokens to buy"); return; }

        const tokenAmount = ethers.BigNumber.from(amt.toString());
        const ethValue    = ethers.utils.parseEther((amt*PRICE_ETH).toString());

        console.log("buyTokens params:", {tokenAmount: tokenAmount.toString(), ethValue: ethValue.toString()});
        const tx = await sellerContract.buyTokens(tokenAmount,{ value: ethValue, gasLimit: 300000 });
        console.log("tx hash:",tx.hash);
        await tx.wait();
        alert("âœ… Purchase complete!");
      }catch(err){
        console.error("Buy failed:",err);
        alert("Tx failed: "+(err.error?.message || err.message || "see console"));
      }
    }

    /* Add token to MetaMask */
    async function addToken(){
      if(!window.ethereum){ alert("Install MetaMask"); return; }
      try{
        await window.ethereum.request({
          method:"wallet_watchAsset",
          params:{type:"ERC20",options:{address:TOKEN_ADDRESS,symbol:TOKEN_SYMBOL,decimals:TOKEN_DECIMALS}}
        });
      }catch(e){ console.error("Add token error:",e); }
    }
  </script>
</body>
</html>
