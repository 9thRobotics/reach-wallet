<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

<script src="https://unpkg.com/@thirdweb-dev/sdk@latest/dist/browser.umd.min.js"></script>
  <style>
    body { background: #111; color: white; font-family: Arial, sans-serif; text-align: center; padding: 40px; }
    button { padding: 12px 20px; font-size: 16px; margin: 10px; background-color: #1c90f3; color: white; border: none; border-radius: 5px; cursor: pointer; }
    input { padding: 10px; font-size: 16px; width: 280px; margin-top: 10px; text-align: center; }
    .popup-info { margin-top: 20px; }
    #buyPopup { display: none; background: #333; padding: 30px; border-radius: 10px; max-width: 400px; margin: 20px auto; }
  </style>
</head>
<body>
  <h1>üîó Reach Token Purchase Portal</h1>
  <button id="connect-wallet">Connect Wallet</button>
  <div id="wallet-address"></div>

  <div style="margin-top: 30px;">
    <label for="manualWallet">Optional Wallet Address (verify match):</label><br />
    <input id="manualWallet" placeholder="0x..." />
  </div>

  <br />
  <div style="background:#222; padding:20px; margin-top:30px; border-radius:10px;">
    <div class="popup-info">
      <div>Token Amount: <span id="tokenQty">0.00</span> 9D-RC</div>
      <div>Price per Token: <span id="pricePerToken">27 USD</span></div>
      <div>Subtotal in ETH: <span id="ethSubtotal">0.000000 ETH</span></div>
      <div>Fee (0.75%): <span id="fee">0.000000 ETH</span></div>
      <div><strong>Total ETH:</strong> <span id="totalEth">0.000000 ETH</span></div>
    </div>
    <label for="tokenAmount">Enter Reach Token amount:</label><br/>
    <input id="tokenAmount" placeholder="Enter token amount" oninput="updateTotals()" type="number" />
    <br /><br />
    <button onclick="showBuyPopup()">‚úÖ Buy Tokens</button>
  </div>

  <div id="buyPopup">
    <div>
      <h2>Confirm Purchase</h2>
      <p>Buy <span id="tokenQtyPopup">0</span> tokens?</p>
      <button id="confirmButton" onclick="buyTokens()" disabled>‚úÖ Confirm</button>
      <button onclick="closePopup()">‚ùå Cancel</button>
    </div>
  </div>

  <div id="status" style="margin-top: 20px;"></div>

  <script>
    let web3Modal, provider, ethersProvider, signer, sdk, contract;
    const tokenUsd = 27, ethUsd = 1867.64, feeRate = 0.0075;

    const providerOptions = {
      walletconnect: {
        package: window.WalletConnectProvider.default,
        options: {
          infuraId: "63f289c3783f403aa722e9bda1b680aa"
        }
      },
      coinbasewallet: {
        package: window.CoinbaseWalletSDK,
        options: {
          appName: "Reach Token",
          infuraId: "63f289c3783f403aa722e9bda1b680aa",
          chainId: 1
        }
      }
    };

    window.onload = () => {
      web3Modal = new window.Web3Modal.default({ cacheProvider: false, providerOptions });
      document.getElementById("connect-wallet").addEventListener("click", connectWallet);
      document.getElementById("manualWallet").addEventListener("input", checkWalletMatch);
    };

    async function connectWallet() {
      try {
        provider = await web3Modal.connect();
        ethersProvider = new ethers.providers.Web3Provider(provider);
        signer = ethersProvider.getSigner();
        const address = await signer.getAddress();
        document.getElementById("wallet-address").innerText = "‚úÖ Connected Wallet: " + address;
        sdk = new thirdweb.ThirdwebSDK(signer, { clientId: "f2bdf5e0c3191caec35b87c25429712a" });
        contract = await sdk.getContract("0x41A61CdCf40a074546423Bae987B81733F3FBAc5", "token");
        checkWalletMatch();
      } catch (e) {
        console.error("Connection error:", e);
        alert("‚ùå Wallet connection failed.");
      }
    }

    function showBuyPopup() {
      document.getElementById("buyPopup").style.display = "block";
      document.getElementById("tokenQtyPopup").innerText = document.getElementById("tokenQty").innerText;
    }

    function closePopup() {
      document.getElementById("buyPopup").style.display = "none";
    }

    function updateTotals() {
      const amount = parseFloat(document.getElementById("tokenAmount").value) || 0;
      const subtotal = amount * tokenUsd;
      const ethSubtotal = subtotal / ethUsd;
      const fee = ethSubtotal * feeRate;
      const total = ethSubtotal + fee;

      document.getElementById("tokenQty").innerText = amount.toFixed(2);
      document.getElementById("ethSubtotal").innerText = ethSubtotal.toFixed(6) + " ETH";
      document.getElementById("fee").innerText = fee.toFixed(6) + " ETH";
      document.getElementById("totalEth").innerText = total.toFixed(6) + " ETH";
    }

    async function checkWalletMatch() {
      const manualAddress = document.getElementById("manualWallet").value.trim().toLowerCase();
      if (!manualAddress || !ethers.utils.isAddress(manualAddress) || !signer) {
        document.getElementById("confirmButton").disabled = true;
        return;
      }

      const connected = (await signer.getAddress()).toLowerCase();
      if (manualAddress === connected) {
        document.getElementById("status").innerText = "‚úÖ Wallet match confirmed.";
        document.getElementById("confirmButton").disabled = false;
      } else {
        document.getElementById("status").innerText = "üö´ Wallet mismatch. Please switch in your wallet.";
        document.getElementById("confirmButton").disabled = true;
      }
    }

    async function buyTokens() {
      const amount = parseFloat(document.getElementById("tokenAmount").value) || 0;
      const usdTotal = amount * tokenUsd;
      const totalEth = (usdTotal / ethUsd) * (1 + feeRate);

      try {
        const tx = await contract.call("buyTokens", [0], {
        value: ethers.utils.parseEther(totalEth.toFixed(6))
      });
          to: "0x41A61CdCf40a074546423Bae987B81733F3FBAc5",
          value: ethers.utils.parseEther(totalEth.toFixed(6))
        });

        document.getElementById("status").innerText = `‚úÖ TX sent: ${tx.hash}`;
        await tx.wait();
        alert("üéâ Purchase confirmed!");
        closePopup();
      } catch (e) {
        console.error(e);
        alert("‚ùå Transaction failed.");
      }
    }
  </script>
</body>
</html>
