<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Buy Reach Token (9D‑RC)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { background:#0a0a0a; color:#fff; font-family:sans-serif; text-align:center; padding:40px }
    input, button { font-size:16px; padding:12px 20px; margin:10px; border-radius:8px }
    button { cursor:pointer; background:#4caf50; border:none; color:#fff }
    button:hover { background:#45a049 }
    .status { margin-top:10px; font-size:14px }
    .error { color:#f44336 }
  </style>
</head>
<body>
  <h1>Reach 9D‑RC Token Sale</h1>

  <button id="connectBtn">Connect Wallet</button>
  <div id="walletStatus" class="status">Wallet not connected</div>

  <h2>Buy Reach Tokens</h2>
  <input type="number" id="tokenAmount" placeholder="Whole Tokens Only" min="1" step="1" />
  <div id="estimate" class="status">Enter token amount</div>
  <button onclick="buyTokens()">Buy Now</button>
  <div id="txStatus" class="status"></div>

  <button onclick="addTokenToWallet()">➕ Add 9D‑RC to Wallet</button>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.5/dist/index.js"></script>

  <script>
    const SELLER_ADDRESS = "0x0557afA4318989702376D50B45547F953B7f9B21";
    const TOKEN_ADDRESS = "0x41a61cdcf40a074546423bae987b81733f3fbac5";
    const CHAINLINK_FEED = "0x5f4ec3df9cbd43714fe2740f5e3616155c5b8419"; // ETH/USD
    const USD_PER_TOKEN = 27;

    let web3Modal, provider, signer, userAddress;
    let isBuying = false;

    // Wallet popup init
    window.onload = async () => {
      web3Modal = new window.Web3Modal.default({
        cacheProvider: false,
        providerOptions: {
          walletconnect: {
            package: window.WalletConnectProvider.default,
            options: {
              rpc: {
                1: "https://mainnet.infura.io/v3/63f289c3783f403aa722e9bda1b680aa"
              }
            }
          }
        }
      });

      document.getElementById("connectBtn").onclick = toggleWallet;
      document.getElementById("tokenAmount").addEventListener("input", updateEstimate);
    };

    async function toggleWallet() {
      if (!provider) return connectWallet();
      disconnectWallet();
    }

    async function connectWallet() {
      try {
        const extProvider = await web3Modal.connect();
        provider = new ethers.providers.Web3Provider(extProvider);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        document.getElementById("walletStatus").textContent = `Connected: ${userAddress}`;
        document.getElementById("connectBtn").textContent = "Disconnect";
      } catch (e) {
        console.error("Connection rejected:", e);
      }
    }

    function disconnectWallet() {
      web3Modal.clearCachedProvider();
      provider = signer = null;
      document.getElementById("walletStatus").textContent = "Wallet not connected";
      document.getElementById("connectBtn").textContent = "Connect Wallet";
    }

    async function getEthPrice() {
      const feed = new ethers.Contract(
        CHAINLINK_FEED,
        [{ "inputs":[],"name":"latestRoundData","outputs":[
          {"name":"roundId","type":"uint80"},
          {"name":"answer","type":"int256"},
          {"name":"startedAt","type":"uint256"},
          {"name":"updatedAt","type":"uint256"},
          {"name":"answeredInRound","type":"uint80"}
        ], "stateMutability":"view", "type":"function" }],
        provider
      );
      const data = await feed.latestRoundData();
      return Number(data.answer) / 1e8;
    }

    async function updateEstimate() {
      const tokens = parseInt(document.getElementById("tokenAmount").value);
      if (!tokens || tokens <= 0 || !Number.isInteger(tokens)) {
        document.getElementById("estimate").textContent = "Enter a whole number";
        return;
      }
      try {
        const ethPrice = await getEthPrice();
        const ethRequired = (tokens * USD_PER_TOKEN) / ethPrice;
        document.getElementById("estimate").textContent = `≈ ${ethRequired.toFixed(6)} ETH ($${tokens * USD_PER_TOKEN})`;
      } catch {
        document.getElementById("estimate").textContent = "Unable to fetch ETH price";
      }
    }

    async function buyTokens() {
      if (isBuying) return alert("Please wait, transaction pending.");
      isBuying = true;

      const tokenAmount = parseInt(document.getElementById("tokenAmount").value);
      if (!tokenAmount || !Number.isInteger(tokenAmount) || tokenAmount <= 0) {
        isBuying = false;
        return alert("Enter a valid whole number of tokens.");
      }

      try {
        const ethPrice = await getEthPrice();
        const ethNeeded = (tokenAmount * USD_PER_TOKEN) / ethPrice;
        const ethValue = ethers.utils.parseEther(ethNeeded.toFixed(6));
        const minTokens = ethers.utils.parseUnits(tokenAmount.toString(), 18);

        const contract = new ethers.Contract(
          SELLER_ADDRESS,
          [{
            "inputs": [{ "internalType": "uint256", "name": "minTokens", "type": "uint256" }],
            "name": "buyTokens",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
          }],
          signer
        );

        const tx = await contract.buyTokens(minTokens, {
          value: ethValue,
          gasLimit: 250000
        });

        document.getElementById("txStatus").textContent = "⏳ Confirming...";
        await tx.wait();
        document.getElementById("txStatus").textContent = "✅ Purchase successful!";
      } catch (err) {
        console.error(err);
        document.getElementById("txStatus").textContent = `❌ ${err.reason || err.message}`;
      }

      isBuying = false;
    }

    async function addTokenToWallet() {
      try {
        await window.ethereum.request({
          method: 'wallet_watchAsset',
          params: {
            type: 'ERC20',
            options: {
              address: TOKEN_ADDRESS,
              symbol: '9D‑RC',
              decimals: 18,
              image: 'https://reachtoken.io/logo.png'
            }
          }
        });
      } catch (err) {
        console.error("Add token error:", err);
      }
    }
  </script>
</body>
</html>
